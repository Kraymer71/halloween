{% extends "base.html" %}
{% block title %}List Your House - Halloween House Map{% endblock %}
{% block content %}
<div class="container grid two">
  <div class="card">
    <form id="listingForm" class="grid">
      <div class="two">
        <div>
          <label>Title</label>
          <input class="input" name="title" placeholder="Spooky Manor" required/>
        </div>
        <div>
          <label>Scare level (1â€”5)</label>
          <input class="input" type="number" min="1" max="5" name="scare_level" value="2"/>
        </div>
      </div>

      <label>Description</label>
      <textarea class="input" name="description" placeholder="Fog machines, skeletons, teal pumpkin for allergy-friendly treats"></textarea>

      <div class="two">
        <div>
          <label>Open from (optional)</label>
          <input class="input" type="time" name="open_from"/>
        </div>
        <div>
          <label>Open to (optional)</label>
          <input class="input" type="time" name="open_to"/>
        </div>
      </div>

      <div>
        <label>Photo (optional)</label>
        <input class="input" type="file" accept="image/*" id="photoInput"/>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn secondary" type="button" id="useLocBtn">Use my location</button>
        <span style="opacity:.7">Tap the map to move the pin.</span>
      </div>

      <button class="btn" type="submit">Submit for approval</button>
    </form>
  </div>

  <div class="card">
    <div id="map" style="height:60vh;width:100%"></div>
  </div>
</div>

<script>
let map, marker;
const DEFAULT_CENTER = "{{ default_center }}".split(',').map(parseFloat);

function initMap(){
  map = L.map('map').setView(DEFAULT_CENTER, 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(map);
  marker = L.marker(DEFAULT_CENTER).addTo(map).bindPopup('Your pin').openPopup();
  map.on('click', (e) => { marker.setLatLng(e.latlng); });
}
initMap();

document.getElementById('useLocBtn').addEventListener('click', ()=>{
  if (!navigator.geolocation) { alert('Geolocation not supported'); return; }
  navigator.geolocation.getCurrentPosition(
    pos => { const p = [pos.coords.latitude, pos.coords.longitude]; marker.setLatLng(p); map.setView(p, 13); },
    err => alert('Could not get your location: ' + err.message),
    { enableHighAccuracy: true, timeout: 10000 }
  );
});

async function uploadPhotoIfAny(file) {
  if (!file) return '';
  const res = await fetch('/api/presign', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ filename: file.name, contentType: file.type })});
  if (!res.ok) { alert('Failed to presign'); return ''; }
  const { url, publicUrl } = await res.json();
  const put = await fetch(url, { method:'PUT', headers:{'content-type': file.type}, body: file });
  if (!put.ok) { alert('Upload failed'); return ''; }
  return publicUrl;
}

document.getElementById('listingForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const form = e.target;
  const data = Object.fromEntries(new FormData(form).entries());
  const photoFile = document.getElementById('photoInput').files[0];
  const photo_url = await uploadPhotoIfAny(photoFile);
  const latlng = marker.getLatLng();
  const payload = {
    title: data.title,
    description: data.description || '',
    lat: latlng.lat, lng: latlng.lng,
    open_from: data.open_from || '',
    open_to: data.open_to || '',
    scare_level: parseInt(data.scare_level || '2', 10),
    photo_url
  };
  const res = await fetch('/api/submit', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(payload) });
  if (!res.ok) { const t = await res.text(); alert('Failed: '+t); return; }
  alert('Submitted! An admin will review your listing.');
  window.location.href = '/';
});
</script>
{% endblock %}
